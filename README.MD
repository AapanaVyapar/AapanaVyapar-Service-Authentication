# Authentication service for aapanavypar

This service is created to enable authentication mechanism in aapanavypar application.

## Services

- **[Signup](#Signup) ( To Create Account ).**

- **[ContactConformation](#ContactConformation) ( To Conform Contact ).**

- **[ResendOTP](#ResendOTP) ( To Resend OTP ).**

- **[GetNewToken](#GetNewToken) ( To Get New Auth Token ).**

- **[SignInWithMail](#SignInWithMail) ( To Login Into Your Account ).**

- **[Logout](#Logout) ( To Logout From Account ).**

- **[ForgetPassword](#ForgetPassword) ( To Initiate Forget Password Flow ).**

- **[ConformForgetPasswordOTP](#ConformForgetPasswordOTP) ( To Validate Your Identity To Forget Password Service ).**

- **[SetNewPassword](#SetNewPassword) ( To Set New Password ).**

### Signup

Request

    message SignUpRequest {
        string username = 25;
        string password = 26;
        string phoneNo = 27;
        string phoneNo = 28;
        string pinCode = 29;
        string apiKey = 106;

    }  
    
Response 
  
    message SignUpResponse {
        oneof data {
            ResponseData responseData = 40;
            ProblemCode code = 32;
        }
        bool authorized = 50;
    }


### ContactConformation

Request

    message ContactConformationRequest {
        string token = 33;
        string otp = 34;
        string apiKey = 107;
    }


Response

    message ContactConformationResponse {
        string token = 35;
        string refreshToken = 36;
    }


### ResendOTP

Request

    message ResendOTPRequest {
        string token = 54;
        string apiKey = 108;
    }

Response

    message ResendOTPResponse {
        OTPResponse response = 55;
        google.protobuf.Duration timeToWaitForNextRequest = 56;
    }

### GetNewToken

Request

    message newTokenRequest {
        string refreshToken = 21;
        string apiKey = 109;
    }

Response

    message newTokenResponse {
        string token = 22;
    }

### SignInWithMail

Request

    message SignInForMailBaseRequest {
        string mail = 8;
        string password = 9;
        string apiKey = 105;
    }

Response

    message SignInForMailBaseResponse {
        oneof data{
            ResponseData responseData = 10;
            ProblemCode code = 11;
        }
    }

### Logout

Request

    message LogoutRequest {
        string token = 36;
        string apiKey = 104;
    }

Response

    message LogoutResponse{
        bool status = 37;
    }

### ForgetPassword

Request

    message ForgetPasswordRequest {
        string phoNo = 55;
        string apiKey = 101;
    }

Response

    message ForgetPasswordResponse {
        oneof data{
            ResponseData responseData = 10;
            ProblemCode code = 11;
        }
    }

### ConformForgetPasswordOTP

Request

    message ConformForgetPasswordOTPRequest {
        string otp = 59;
        string token = 60;
        string apiKey = 102;
    }

Response

    message ConformForgetPasswordOTPResponse {
        string newPassToken = 71;
    }

### SetNewPassword

Request

    message SetNewPasswordRequest {
        string newPassToken = 72;
        string newPassword = 73;
        string apiKey = 103;
    }

Response

    message SetNewPasswordResponse {
        bool status = 74;
    }

### Highlight's

1. A Token generated by a rpc (function) can only be utilized by the specified rpc's.
2. All the requests are first sanitized and then processed.
3. The token is encrypted and then only send to the client.
4. OTP is conformed on server side.
5. The user can be able to get otp 6 times in all cases for a particular account
   1st --> First time otp get send automatically.
   2nd --> when user click on resend otp.
   3rd --> After 5 min wait when user click on resend otp.
   4th --> After 5 min wait when user click on resend otp.
   5th --> After 10 min wait when user click on resend otp.
   6th --> After 12 min wait when user click on resend otp.

### Data Flow's

1. SignUp :
   
   1. Check For API Key; If API key is valid then go to step-2 else send Error "UnAuthorized Access". 
   2. Sanitize the inputs provided in the input form the user; If input provided by the user are not valid then send error "Invalid Input" else go to step-3. 
   3. Check is user already exist ? or not  in the cash by users phone number; If user already exist then send error "Already Exist" else go to step-4. 

     **Now as a security mechanism to avoid ddos attack form an unknown person by passing same unregistered contact number again and again and try to get OTP.** 
     **But if good user try to register and unfortunately at the time of OTP conformation his device failed then the user can register after a half hour.** 
     **Or frontend can redirect the user with that inprogress contact number directly to the otp conformation page.** 

   4. Now Check is user with provided contact number is inprogress or not ?. If it is then send error "In progress" else go to step-5. 
   5. Generate Random UUID For new user. 
   6. Generate the hash of password.
   7. Create the user temporarily in cash (Note : User Exist or not is validated by cash data). 
   8. Generate Refresh and Auth Tokens. 
   9. Send OTP to the contact number. 
   10. Send The Generated Refresh token and auth token to the user. 

    ** Here the token can only access to the following services : GetNewToken, ResendOTP, ConformContact, LogOut ** 


2. SignIn :

   1. Check For API Key; If API key is valid then go to step-2 else send Error "UnAuthorized Access".
   2. Sanitize the inputs provided in the input form the user; If input provided by the user are not valid then send error "Invalid Input" else go to step-3.
   3. Check is provided contact number is exist or not (Checking in cash) if pass then go to step-4 else send error "Not Exist".
   4. Get the user password's hash by phoneNo and then Hash the provided password and compare it with hash of password store in database
   5. If comparison is passed then user exist go to step-6 else send error "Not exist".
   6. Generate Refresh token and auth token and send them to client.

3. LogOut :

   1. Check For API Key; If API key is valid then go to step-2 else send Error "UnAuthorized Access".
   2. Validate Auth Token; If token is valid then go to step-3 else send error "UnAuthorized".
   3. Delete Refresh and Auth token.
   4. On Successful deletion of token send status to true else false.

4. ContactConformation : 

   1. Check For API Key; If API key is valid then go to step-2 else send Error "UnAuthorized Access".
   2. Validate Auth Token; If token is valid then go to step-3 else send error "UnAuthorized".
   3. Get sent OTP from server cash.
   4. Check if OTP is equal to users typed OTP ? if equal then go to step-5 else send error "Invalid OTP".
   5. Get temporary user form cash.
   6. Delete Refresh token, OTP data, Temporary phoneNo from cash.
   7. Create Actual user in DataBase.
   8. Delete Temporary User data from cash.
   9. Generate Refresh and Auth token and send them to user.
   
5. Resend OTP :
